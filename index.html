<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Калькулятор инвойса</title>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
  <style>
    :root{
      --bg:#0b1220;--panel:#121a2b;--muted:#1a2336;--text:#e6ecff;--sub:#a8b3cf;--acc:#7c9cff;--ok:#45d483;--warn:#ffd166;
      --radius:18px;--shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,rgba(124,156,255,.12),transparent),
                     radial-gradient(1200px 800px at 100% 10%,rgba(69,212,131,.10),transparent),
                     var(--bg);color:var(--text);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji"}
                     @font-face {
  font-family: 'Postertoastermono';
  src: url('/fonts/Postertoastermono.woff') format('woff'),
       url('/fonts/Postertoastermono.woff2') format('woff2');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}
    .wrap{max-width:1100px;margin:32px auto;padding:16px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:20px}
    @media (max-width:900px){.grid{grid-template-columns:1fr;}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
          border:1px solid rgba(124,156,255,.15);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
          h1{
  font-family: 'Postertoastermono', Inter, system-ui, -apple-system, "Segoe UI",
               Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial, sans-serif;
  font-size: 48px;
  margin: 0 0 14px;
}
    h2{font-size:21px;margin:14px 0 20px;color:var(--sub)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .row+.row{margin-top:12px}
    .row-3 + .row-3 {margin-top: 12px}
    .row + .row-3 {margin-top: 28px}
    label{font-size:13px;color:var(--sub);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:12px 12px;border-radius:12px;background:var(--muted);border:1px solid rgba(255,255,255,.06);
                 color:var(--text);outline:none;transition:.2s}
      select#ccy {
      /* базовые стили остаются */
  padding-right: 40px;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;

  /* один шортхэнд: цвет + картинка + повтор + позиция + размер */
  background:
    var(--muted)
    url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path fill='%23a8b3cf' d='M7 9l5 5 5-5z'/></svg>")
    no-repeat right 12px center / 16px 16px;
    }
    input:focus,select:focus,textarea:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(124,156,255,.25)}
    textarea{height:116px;font-family:inherit}
    .hr{height:1px;background:rgba(255,255,255,.06);margin:12px 20px}
    .item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px}
    .item.em{background:rgba(124,156,255,.08)}
    .item.em + .item.em { margin-top: 4px; margin-bottom: 16px; }
    .key{font-size:14px;color:var(--sub)}
    .val{font-variant-numeric:tabular-nums;font-weight:600}
    .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(69,212,131,.12);
         color:var(--ok);font-size:12px;border:1px solid rgba(69,212,131,.35)}
    .warn{background:rgba(255,209,102,.12);color:var(--warn);border-color:rgba(255,209,102,.4)}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:12px;background:var(--acc);color:#0b1220;font-weight:600;border:none;box-shadow:var(--shadow);cursor:pointer}
    .btn.copied{background:var(--ok)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;align-items:center;justify-content:space-between;margin-top:16px}
    .stamp{font-size:12px;color:var(--sub)}
    .offer-section{margin-top:44px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Калькулятор инвойса</h1>
    <div class="grid">
      <section class="card">
        <h2>Входные данные</h2>
        <div class="row">
          <div>
            <label>Сумма инвойса</label>
            <input id="amount" type="number" min="0" step="0.01" value="0" />
          </div>
          <div>
            <label>Валюта</label>
            <select id="ccy">
              <option selected>USD</option>
              <option>EUR</option>
              <option>CNY</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Тариф, %</label>
            <input id="tariff" type="number" min="0" step="0.01" value="5" />
          </div>
          <div>
            <label>Процент конвертации, % </label>
            <input id="conv" type="number" min="0" step="0.01" value="3" />
          </div>
        </div>
        <div class="row-3">
          <div>
            <label>Курс ЦБ USD</label>
            <input id="rateUSD" type="number" step="0.0001" value="79.7796" />
          </div>
          <div>
            <label>Курс ЦБ EUR</label>
            <input id="rateEUR" type="number" step="0.0001" value="92.8800" />
          </div>
          <div>
            <label>Курс ЦБ CNY</label>
            <input id="rateCNY" type="number" step="0.0001" value="11.0665" />
          </div>
        </div>
        <div class="row-3">
          <div>
            <label id="convLblUSD">USD +0%</label>
            <input id="convRateUSD" type="number" step="0.0001" readonly />
          </div>
          <div>
            <label id="convLblEUR">EUR +0%</label>
            <input id="convRateEUR" type="number" step="0.0001" readonly />
          </div>
          <div>
            <label id="convLblCNY">CNY +0%</label>
            <input id="convRateCNY" type="number" step="0.0001" readonly />
          </div>
        </div>
        <div class="toolbar">
          <button id="refreshBtn" class="btn" type="button">Обновить курсы ЦБ</button>
          <span id="rateStamp" class="stamp">Последнее обнов: —</span>
        </div>
        <section class="offer-section">
          <h2>Предложение</h2>
          <textarea id="offerText" readonly></textarea>
          <div class="toolbar">
            <button id="copyBtn" class="btn" type="button">Скопировать</button>
          </div>
        </section>
      </section>
      <section class="card">
        <h2>Результат</h2>
        <div id="swiftTag" class="tag" style="display:none">SWIFT потребуется</div>
        <div id="noSwiftTag" class="tag warn" style="display:none">SWIFT не применяется</div>
        <div class="hr"></div>
        <div class="item"><div class="key">Сумма с тарифом</div><div class="val" id="amountWithTariff">—</div></div>
        <div class="item"><div class="key">SWIFT</div><div class="val" id="swiftFee">—</div></div>
        <div class="hr"></div>
        <div class="item em"><div class="key">Итог для клиента</div><div class="val" id="totalCcy">—</div></div>
        <div class="item em"><div class="key">Итог для клиента (₽)</div><div class="val" id="totalRub">—</div></div>
        <div class="hr"></div>
        <h2>Комиссии</h2>
        <div class="item"><div class="key">Общая комиссия</div><div class="val" id="totalCommissionCcy">—</div></div>
        <div class="item"><div class="key">Себестоимость</div><div class="val" id="kzCcy">—</div></div>
        <div class="item"><div class="key">Себестоимость (₽)</div><div class="val" id="kzRub">—</div></div>
        <div class="hr"></div>
        <div class="item"><div class="key">Наша комиссия</div><div class="val" id="ourCcy">—</div></div>
        <div class="item"><div class="key">Наша комиссия (₽)</div><div class="val" id="ourRub">—</div></div>
      </section>
    </div>
  </div>
  <script>
    const $ = (id) => document.getElementById(id);
    function formatNumberWithSpaces(num){
      if(!isFinite(num)) return '0.00';
      const parts = num.toFixed(2).split('.');
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '\u00A0');
      return parts.join('.');
    }
    const sym = (ccy) => ccy==='USD'?'$':(ccy==='EUR'?'€':(ccy==='CNY'?'¥':''));
    const money = (v, ccy) => ccy === 'RUB' ? `${formatNumberWithSpaces(v)}\u00A0₽` : `${sym(ccy)}\u00A0${formatNumberWithSpaces(v)}`;
    const amount = $('amount');
    const ccy = $('ccy');
    const tariff = $('tariff');
    const conv = $('conv');
    const rateUSD = $('rateUSD');
    const rateEUR = $('rateEUR');
    const rateCNY = $('rateCNY');
    const convRateUSD = $('convRateUSD');
    const convRateEUR = $('convRateEUR');
    const convRateCNY = $('convRateCNY');
    const convLblUSD = $('convLblUSD');
    const convLblEUR = $('convLblEUR');
    const convLblCNY = $('convLblCNY');
    const swiftTag = $('swiftTag');
    const noSwiftTag = $('noSwiftTag');
    const amountWithTariff = $('amountWithTariff');
    const swiftFee = $('swiftFee');
    const totalCcy = $('totalCcy');
    const totalRub = $('totalRub');
    const totalCommissionCcy = $('totalCommissionCcy');
    const kzCcy = $('kzCcy');
    const kzRub = $('kzRub');
    const ourCcy = $('ourCcy');
    const ourRub = $('ourRub');
    const rateStamp = $('rateStamp');
    const refreshBtn = $('refreshBtn');
    const offerText = $('offerText');
    const copyBtn = $('copyBtn');
    function currentCBRate(){
      const cur = ccy.value;
      if(cur==='USD') return +rateUSD.value || 0;
      if(cur==='EUR') return +rateEUR.value || 0;
      if(cur==='CNY') return +rateCNY.value || 0;
      return 0;
    }
    function recalc(){
      const S = +amount.value || 0;
      const T = (+tariff.value||0)/100;
      const pConv = (+conv.value||0)/100;
      const convPct = (+conv.value||0);
      const usd = +rateUSD.value || 0;
      const eur = +rateEUR.value || 0;
      const cny = +rateCNY.value || 0;
      const kCB = currentCBRate();
      const denom = (1-pConv);
      const kConv = (kCB>0 && denom>0) ? kCB/denom : 0;
      const convUsdRate = (usd>0 && denom>0) ? usd/denom : 0;
      const convEurRate = (eur>0 && denom>0) ? eur/denom : 0;
      const convCnyRate = (cny>0 && denom>0) ? cny/denom : 0;
      if(convLblUSD) convLblUSD.textContent = `USD +${convPct}%`;
      if(convLblEUR) convLblEUR.textContent = `EUR +${convPct}%`;
      if(convLblCNY) convLblCNY.textContent = `CNY +${convPct}%`;
      const sUsdEq = (usd>0 && kCB>0) ? (S*kCB)/usd : 0;
      const needSwift = sUsdEq>0 && sUsdEq<10000;
      const amtWithTariff = (1-T>0) ? S/(1-T) : 0;
      let swiftInCcy = 0;
      if(needSwift){
        if(ccy.value==='USD' || ccy.value==='EUR') swiftInCcy = 100;
        else swiftInCcy = (usd>0 && kCB>0) ? (100*usd)/kCB : 0;
      }
      const totalInCcyVal = amtWithTariff + swiftInCcy;
      const totalInRubVal = totalInCcyVal * kConv;
      const kzBase = (S*0.035)/(1-0.035);
      const kzInCcyVal = kzBase + swiftInCcy;
      const ourInCcyVal = (S*T)/(1-T) - kzBase;
      const totalCommissionInCcyVal = kzInCcyVal + ourInCcyVal;
      const kzInRubVal = kzInCcyVal * kConv;
      const ourInRubVal = ourInCcyVal * kConv;
      amountWithTariff.textContent = money(amtWithTariff, ccy.value);
      swiftFee.textContent = money(swiftInCcy, ccy.value);
      totalCcy.textContent = money(totalInCcyVal, ccy.value);
      totalRub.textContent = money(totalInRubVal, 'RUB');
      totalCommissionCcy.textContent = money(totalCommissionInCcyVal, ccy.value);
      kzCcy.textContent = money(kzInCcyVal, ccy.value);
      kzRub.textContent = money(kzInRubVal, 'RUB');
      ourCcy.textContent = money(ourInCcyVal, ccy.value);
      ourRub.textContent = money(ourInRubVal, 'RUB');
      if(convRateUSD) convRateUSD.value = convUsdRate.toFixed(4);
      if(convRateEUR) convRateEUR.value = convEurRate.toFixed(4);
      if(convRateCNY) convRateCNY.value = convCnyRate.toFixed(4);
      swiftTag.style.display = needSwift ? 'inline-flex' : 'none';
      noSwiftTag.style.display = needSwift ? 'none' : 'inline-flex';
      if(offerText) {
        offerText.value = `Сумма к оплате: ${money(totalInCcyVal, ccy.value)}\n` +
                          `Тариф: ${formatNumberWithSpaces(+tariff.value)}%\n` +
                          `Сбор за SWIFT: ${swiftInCcy ? money(swiftInCcy, ccy.value) : 'Отсутствует'}\n` +
                          `Итого: ${money(S, ccy.value)} × ${formatNumberWithSpaces(+tariff.value)}% = ${money(totalInCcyVal, ccy.value)}\n` +
                          `Валютные счета оплачиваются в рублях по курсу ЦБ РФ +1,5-3%`;
      }
    }
    async function fetchCBRates(){
      try {
        if(rateStamp) rateStamp.textContent = 'Загрузка курсов ЦБ...';
        if(refreshBtn) refreshBtn.disabled = true;
        console.log('Fetching exchange rates from CBR...');
        const res = await fetch('https://corsproxy.io/?https://www.cbr-xml-daily.ru/daily_json.js', { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
        const data = await res.json();
        console.log('API Response:', data);
        if (!data?.Valute) throw new Error('Неверная структура ответа API');
        if(data.Valute.USD?.Value) rateUSD.value = Number(data.Valute.USD.Value).toFixed(4);
        if(data.Valute.EUR?.Value) rateEUR.value = Number(data.Valute.EUR.Value).toFixed(4);
        if(data.Valute.CNY?.Value) rateCNY.value = Number(data.Valute.CNY.Value).toFixed(4);
        const dt = new Date(data?.Date || Date.now());
        if(rateStamp) rateStamp.textContent = 'Курсы ЦБ на ' + dt.toLocaleDateString('ru-RU');
        if(refreshBtn) {
          refreshBtn.textContent = 'Обновлено';
          refreshBtn.classList.add('copied');
          setTimeout(() => {
            refreshBtn.textContent = 'Обновить курсы ЦБ';
            refreshBtn.classList.remove('copied');
          }, 2000);
        }
        recalc();
      } catch(e) {
        console.error('Error fetching CB rates:', e);
        if(rateStamp) rateStamp.textContent = 'Ошибка загрузки курсов ЦБ: ' + e.message;
      } finally {
        if(refreshBtn) refreshBtn.disabled = false;
      }
    }
    if(refreshBtn) {
      refreshBtn.addEventListener('click', fetchCBRates);
      console.log('Refresh button event listener attached');
    } else {
      console.error('Refresh button not found');
    }
    if(copyBtn) {
      copyBtn.addEventListener('click', () => {
        if(offerText) {
          navigator.clipboard.writeText(offerText.value)
            .then(() => {
              copyBtn.textContent = 'Скопировано';
              copyBtn.classList.add('copied');
              setTimeout(() => {
                copyBtn.textContent = 'Скопировать';
                copyBtn.classList.remove('copied');
              }, 2000);
            })
            .catch(err => {
              console.error('Ошибка копирования:', err);
              alert('Ошибка копирования текста');
            });
        }
      });
    } else {
      console.error('Copy button not found');
    }
    [amount, ccy, tariff, conv, rateUSD, rateEUR, rateCNY].forEach(el=>{
      el.addEventListener('input', recalc);
      el.addEventListener('change', recalc);
    });
    fetchCBRates();
    recalc();
  </script>
</body>
</html>