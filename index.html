<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Калькулятор инвойса</title>
  <style>
    :root{
      --bg:#0b1220;--panel:#121a2b;--muted:#1a2336;--text:#e6ecff;--sub:#a8b3cf;--acc:#7c9cff;--ok:#45d483;--warn:#ffd166;
      --radius:18px;--shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,rgba(124,156,255,.12),transparent),
                     radial-gradient(1200px 800px at 100% 10%,rgba(69,212,131,.10),transparent),
                     var(--bg);color:var(--text);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .wrap{max-width:1100px;margin:32px auto;padding:16px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:20px}
    @media (max-width:900px){.grid{grid-template-columns:1fr;}}

    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
          border:1px solid rgba(124,156,255,.15);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
    h1{font-size:28px;margin:0 0 14px}
    h2{font-size:18px;margin:0 0 10px;color:var(--sub)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .row+.row,.row-3+.row,.row+.row-3{margin-top:12px}

    label{font-size:13px;color:var(--sub);display:block;margin-bottom:6px}
    input,select{width:100%;padding:12px 14px;border-radius:12px;background:var(--muted);border:1px solid rgba(255,255,255,.06);
                 color:var(--text);outline:none;transition:.2s}
    input:focus,select:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(124,156,255,.25)}

    .hr{height:1px;background:rgba(255,255,255,.06);margin:14px 0}

    .item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:12px}
    .item.em{background:rgba(124,156,255,.08)}
    .key{font-size:14px;color:var(--sub)}
    .val{font-variant-numeric:tabular-nums;font-weight:600}

    .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(69,212,131,.12);
         color:var(--ok);font-size:12px;border:1px solid rgba(69,212,131,.35)}
    .warn{background:rgba(255,209,102,.12);color:var(--warn);border-color:rgba(255,209,102,.4)}

    .btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:12px;background:var(--acc);color:#0b1220;font-weight:600;border:none;box-shadow:var(--shadow);cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
    .stamp{font-size:12px;color:var(--sub)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Калькулятор инвойса</h1>
    <div class="grid">
      <section class="card">
        <h2>Входные данные</h2>
        <div class="row">
          <div>
            <label>Сумма инвойса</label>
            <input id="amount" type="number" min="0" step="0.01" value="4915" />
          </div>
          <div>
            <label>Валюта</label>
            <select id="ccy">
              <option>USD</option>
              <option selected>EUR</option>
              <option>CNY</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Тариф, % (обратным счётом)</label>
            <input id="tariff" type="number" min="0" step="0.01" value="5" />
          </div>
          <div>
            <label>Конвертация к курсу, % (обратным счётом)</label>
            <input id="conv" type="number" min="0" step="0.01" value="3" />
          </div>
        </div>

        <div class="row-3">
          <div>
            <label>Курс ЦБ USD → ₽</label>
            <input id="rateUSD" type="number" step="0.0001" value="79.7796" />
          </div>
          <div>
            <label>Курс ЦБ EUR → ₽</label>
            <input id="rateEUR" type="number" step="0.0001" value="92.8800" />
          </div>
          <div>
            <label>Курс ЦБ CNY → ₽</label>
            <input id="rateCNY" type="number" step="0.0001" value="11.0665" />
          </div>
        </div>
        <div class="toolbar">
          <button id="refreshBtn" class="btn" type="button">Обновить курсы ЦБ</button>
          <span id="rateStamp" class="stamp">Последнее обнов: —</span>
        </div>
      </section>

      <section class="card">
        <h2>Результат</h2>
        <div id="swiftTag" class="tag" style="display:none">SWIFT потребуется</div>
        <div id="noSwiftTag" class="tag warn" style="display:none">SWIFT не применяется</div>

        <div class="hr"></div>

        <div class="item"><div class="key">Сумма с тарифом</div><div class="val" id="amountWithTariff">—</div></div>
        <div class="item"><div class="key">SWIFT добавка</div><div class="val" id="swiftFee">—</div></div>
        <div class="item em"><div class="key">Итог для клиента</div><div class="val" id="totalCcy">—</div></div>
        <div class="item em"><div class="key">Итог для клиента (₽)</div><div class="val" id="totalRub">—</div></div>

        <div class="hr"></div>
        <h2>Комиссии</h2>
        <div class="item"><div class="key">Комиссия казахов</div><div class="val" id="kzCcy">—</div></div>
        <div class="item"><div class="key">Комиссия казахов (₽)</div><div class="val" id="kzRub">—</div></div>
        <div class="item"><div class="key">Наша комиссия</div><div class="val" id="ourCcy">—</div></div>
        <div class="item"><div class="key">Наша комиссия (₽)</div><div class="val" id="ourRub">—</div></div>
      </section>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // формат с пробелами по 3 цифры + 2 знака после запятой (ГОСТоподобно)
    function formatNumberWithSpaces(num){
      if(!isFinite(num)) return '0.00';
      const parts = num.toFixed(2).split('.');
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '\u00A0'); // неразрывный пробел
      return parts.join('.');
    }
    const sym = (ccy) => ccy==='USD'?'$':(ccy==='EUR'?'€':(ccy==='CNY'?'¥':''));
    const money = (v, ccy) => `${formatNumberWithSpaces(v)}${ccy?`\u00A0${sym(ccy)}`:''}`;

    const amount = $('amount');
    const ccy = $('ccy');
    const tariff = $('tariff');
    const conv = $('conv');
    const rateUSD = $('rateUSD');
    const rateEUR = $('rateEUR');
    const rateCNY = $('rateCNY');

    const swiftTag = $('swiftTag');
    const noSwiftTag = $('noSwiftTag');

    const amountWithTariff = $('amountWithTariff');
    const swiftFee = $('swiftFee');
    const totalCcy = $('totalCcy');
    const totalRub = $('totalRub');

    const kzCcy = $('kzCcy');
    const kzRub = $('kzRub');
    const ourCcy = $('ourCcy');
    const ourRub = $('ourRub');

    const rateStamp = $('rateStamp');
    const refreshBtn = $('refreshBtn');

    function currentCBRate(){
      const cur = ccy.value;
      if(cur==='USD') return +rateUSD.value || 0;
      if(cur==='EUR') return +rateEUR.value || 0;
      if(cur==='CNY') return +rateCNY.value || 0;
      return 0;
    }

    function recalc(){
      const S = +amount.value || 0;
      const T = (+tariff.value||0)/100;
      const pConv = (+conv.value||0)/100;

      // CB rates
      const usd = +rateUSD.value || 0;
      const kCB = currentCBRate();

      // Conversion rate with markup (reverse)
      const kConv = kCB>0 ? kCB/(1-pConv) : 0;

      // USD equivalent of original invoice (cross via CB rates)
      const sUsdEq = (usd>0 && kCB>0) ? (S*kCB)/usd : 0;
      const needSwift = sUsdEq>0 && sUsdEq<10000;

      // Amount with tariff (reverse)
      const amtWithTariff = (1-T>0) ? S/(1-T) : 0;

      // SWIFT fee in invoice currency (AFTER tariff) and fully to KZ commission
      let swiftInCcy = 0;
      if(needSwift){
        if(ccy.value==='USD' || ccy.value==='EUR') swiftInCcy = 100;
        else swiftInCcy = (usd>0 && kCB>0) ? (100*usd)/kCB : 0; // для прочих (у нас нет OTHER)
      }

      const totalInCcyVal = amtWithTariff + swiftInCcy;
      const totalInRubVal = totalInCcyVal * kConv;

      // Commissions
      const kzBase = (S*0.035)/(1-0.035);
      const kzInCcyVal = kzBase + swiftInCcy; // SWIFT → казахи
      const ourInCcyVal = (S*T)/(1-T) - kzBase; // наша прибыль; SWIFT не включается

      const kzInRubVal = kzInCcyVal * kConv;
      const ourInRubVal = ourInCcyVal * kConv;

      // Render (везде символ валюты и пробелы по 3)
      amountWithTariff.textContent = money(amtWithTariff, ccy.value);
      swiftFee.textContent = money(swiftInCcy, ccy.value);
      totalCcy.textContent = money(totalInCcyVal, ccy.value);
      totalRub.textContent = money(totalInRubVal, 'RUB').replace('RUB','₽');
      kzCcy.textContent = money(kzInCcyVal, ccy.value);
      kzRub.textContent = money(kzInRubVal, 'RUB').replace('RUB','₽');
      ourCcy.textContent = money(ourInCcyVal, ccy.value);
      ourRub.textContent = money(ourInRubVal, 'RUB').replace('RUB','₽');

      swiftTag.style.display = needSwift ? 'inline-flex' : 'none';
      noSwiftTag.style.display = needSwift ? 'none' : 'inline-flex';
    }

    // загрузка курсов ЦБ (USD/EUR/CNY)
    async function fetchCBRates(){
      try{
        if(rateStamp) rateStamp.textContent = 'Загрузка курсов ЦБ...';
        if(refreshBtn) refreshBtn.disabled = true;
        const res = await fetch('https://www.cbr-xml-daily.ru/daily_json.js');
        const data = await res.json();
        if(data?.Valute?.USD?.Value){ rateUSD.value = Number(data.Valute.USD.Value).toFixed(4); }
        if(data?.Valute?.EUR?.Value){ rateEUR.value = Number(data.Valute.EUR.Value).toFixed(4); }
        if(data?.Valute?.CNY?.Value){ rateCNY.value = Number(data.Valute.CNY.Value).toFixed(4); }
        recalc();
        const dt = new Date(data?.Date || Date.now());
        if(rateStamp) rateStamp.textContent = 'Курсы ЦБ на ' + dt.toLocaleDateString('ru-RU');
      }catch(e){
        if(rateStamp) rateStamp.textContent = 'Не удалось загрузить курсы ЦБ';
      }finally{
        if(refreshBtn) refreshBtn.disabled = false;
      }
    }

    if(refreshBtn) refreshBtn.addEventListener('click', fetchCBRates);

    // Events
    [amount, ccy, tariff, conv, rateUSD, rateEUR, rateCNY].forEach(el=>{
      el.addEventListener('input', recalc);
      el.addEventListener('change', recalc);
    });

    // Init
    fetchCBRates();
    recalc();
  </script>
</body>
</html>
